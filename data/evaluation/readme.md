# 回答の精度評価

問題に対する回答を模範解答と比較して評価する.

## 前準備

### 模範解答の準備

問題に対する模範解答ファイルを作成しておく. フォーマットは以下のような**ヘッダーなし**のcsvファイル.

|  index  |  answer  | evidence |
| ---- | ---- | ---- |
|  0  |  "あいうえお"  | hoge |
|  ...  |  ...  | ... |

`index`は問題番号, `answer`は解答に当たるテキスト文, `evidence`は解答に対する根拠. サンプルが`data/ans_txt.csv`として用意してある.

### 予測回答の作成

評価したい予測回答を作成する. フォーマットは模範解答と同じで, `index`は存在するすべての問題を網羅する必要がある. サンプルが`submit/predictions.csv`として与えられている.

### 環境構築

Dockerから環境構築が可能である. Docker Engineなど, Dockerを使用するために必要なものがない場合はまずはそれらを導入しておく. [Docker Desktop](https://docs.docker.com/get-docker/)を導入すると必要なものがすべてそろうので, 自身の環境に合わせてインストーラをダウンロードして導入しておくことが望ましい. 現状, Linux, Mac, Windowsに対応している. そして, `/path/to/evaluation`に同封してある`docker-compose.yml`で定義されたコンテナを, 以下のコマンドを実行することで立ち上げる.

```bash
$ docker compose up -d
...
```

コンテナに入る.

```bash
$ docker exec -it rag_env bash
...
```

Dockerから環境構築が難しい場合はPython環境において以下のライブラリをインストールすればほぼ使用可能となる.

```bash
ticktoken==0.7.0
pandas==2.2.2
openai==1.30.1
```

以下, コンテナ内での作業とする.

### LLMの設定

`OPENAI_API_KEY`を設定する.

```bash
$ OPENAI_API_KEY={YOUR_API_KEY}
$ export OPENAI_API_KEY
...
```

## 精度評価

精度評価は大きく分けて以下のフローに従う.

1. [検証フェーズ](#検証フェーズ)
1. [最終スコアの計算フェーズ](#最終スコアの計算フェーズ)

### 検証フェーズ

予測回答のフォーマットチェックを行う. 以下のような内容.

#### ファイル拡張子の確認

予測回答ファイルの拡張子が`csv`となっているか確認する.

#### カラム数確認

ここでは`index`, `answer`, `evidence`の3つのカラムが存在すると仮定しており, それらが過不足なく存在するかを確認する.

#### サンプル数の確認

模範解答の中で用意されている問題数を過不足なく含んでいるかを確認する.

#### 欠損の確認

欠損(回答が空)が存在するかを確認する.

#### データ型確認

模範解答とデータ型が一致しているかを確認する.

#### トークン数の確認

各回答のトークン数を確認して上限を超えていないかを確認する.

### 最終スコアの計算フェーズ

各問題に対する回答と模範解答を比較して点数を付けて, 最終的な精度評価はすべての問題の平均値とする. 評価結果の定義と基準は以下の通り.

| 評価結果 | 点数 | 内容 |
| ---- | ---- | ---- |
| Perfect | 1 | 質問に対して正確に答え, 虚偽の内容が含まれていない回答. |
| Acceptable | 0.5 | 質問に対して有用な答えを提供しているが, 答えの有用性を損なわない程度の軽微な誤りが含まれている回答. |
| Missing | 0 | 質問に対して「わかりません」「見つけられませんでした」などの具体的な答えがない回答. |
| Incorrect | -1 | 質問に対して間違った, または関連性のない回答. |

### 実行の仕方

[前準備](#前準備)を行った前提で, 以下のコマンドを実行することで精度評価結果を得る.

```bash
$ python crag.py
...
```

実行に成功すると以下のような結果が出力される.

```bash
Format Setting:
  time elapsed: 0.004658937454223633[s]

Validation:
  Checking data...Done
  Checking samples...Done
  Checking dtype...Done
  Checking tokens...Done
  time elapsed: 0.42585062980651855[s]

Loading Ground Truth:
  db shape: (5, 2)
  time elapsed: 0.0020058155059814453[s]

Evaluation:
  By CRAG
  llm: gpt-4o-2024-08-06
5it [00:03,  1.46it/s]
  time elapsed: 3.4229791164398193[s]


Saving the Results:
  Score: -0.1
  time elapsed: 0.015525341033935547[s]
```

`Score`が実際の精度評価結果である. デフォルトでは最終評価結果が`./result`以下に以下のような`scoring.csv`として作成される.

```bash
1,Acceptable,1
2,Perfect,4
3,Missing,4
4,Incorrect,5
5,Incorrect,1
```

左から問題番号, 評価結果, 回答のトークン数である.
